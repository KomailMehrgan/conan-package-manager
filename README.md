# Walkthrough: Modern C++ with OpenCV and Conan on Windows

This guide provides a clear, step-by-step process for setting up a C++ project that uses the OpenCV library on Windows. We will use the [Conan C++ Package Manager](https://conan.io/) and [CMake](https://cmake.org/) to create a modern, reproducible build environment.

This walkthrough addresses common issues, such as linker errors (`LNK2019`) and runtime "missing DLL" errors, by providing a robust configuration from the start.

## Prerequisites

Before you begin, ensure you have the following tools installed and accessible from your terminal:

1.  **C++ Compiler:** A recent version of the Visual Studio C++ toolchain (the "Desktop development with C++" workload from the Visual Studio Installer is perfect).
2.  **CMake:** Version 3.21 or newer.
3.  **Conan:** Version 2.x.

You can verify your installations by running `cl`, `cmake --version`, and `conan --version` in a terminal.

---

## Step 1: Create the Project Files

First, create a new folder for your project. Inside this folder, create the following three files.

### 1. `conanfile.txt`

This file tells Conan which libraries your project needs. We will require `opencv` and its problematic dependency, `xz_utils`, and configure it correctly.

```txt
[requires]
# We use opencv/4.11.0, but this method also works for other versions.
opencv/4.11.0
xz_utils/5.4.5

[generators]
CMakeDeps
CMakeToolchain

[layout]
cmake_layout

[options]
# This is crucial: it forces Conan to use a shared library for xz_utils,
# which resolves common linker errors with OpenCV on Windows.
xz_utils/*:shared=True
```

### 2. `CMakeLists.txt`

This is the build script for CMake. It defines how to compile our program and link it against the libraries provided by Conan.

```cmake
cmake_minimum_required(VERSION 3.21)
project(OpenCV_Conan_Demo CXX)

# This command finds the libraries (OpenCV and its dependencies)
# that were downloaded by Conan.
find_package(OpenCV REQUIRED)

# Add our executable program, which is created from main.cpp.
add_executable(main main.cpp)

# This is the key to fixing the linker errors. We link our program
# against both OpenCV and the LZMA library it depends on.
target_link_libraries(main PRIVATE opencv::opencv LibLZMA::LibLZMA)
```

### 3. `main.cpp`

This is our simple C++ program that uses OpenCV to create and display an image with a green circle.

```cpp
#include <iostream>
#include <opencv2/opencv.hpp>

int main() {
    std::cout << "OpenCV version: " << CV_VERSION << std::endl;
    std::cout << "Creating a simple image..." << std::endl;

    // Create a black 400x400 image
    cv::Mat image = cv::Mat::zeros(400, 400, CV_8UC3);

    // Draw a solid green circle in the center
    cv::circle(image, cv::Point(200, 200), 100, cv::Scalar(0, 255, 0), -1);

    // Display the image in a window
    cv::imshow("OpenCV + Conan Demo", image);

    // Wait for a key press before closing the window
    cv::waitKey(0);

    return 0;
}
```

---

## Step 2: Build the Project

With all three files in place, open your terminal (PowerShell or CMD) and navigate to your project's root folder. Run the following commands in order.

### 1. Install Dependencies

This command reads your `conanfile.txt` and downloads/builds the correct libraries.

```powershell
conan install . --build=missing
```

### 2. Configure the Build

This command runs CMake to prepare the build system. It reads the presets automatically generated by Conan.

```powershell
cmake --preset conan-default
```

### 3. Compile the Program

This command compiles your `main.cpp` and links it with the libraries to create `main.exe`.

```powershell
cmake --build --preset conan-release
```

After this step, you will have your executable located at `build\Release\main.exe`.

---

## Step 3: Run the Application

If you try to run `main.exe` directly, you will get an error about missing `.dll` files. This is because the program needs access to the shared libraries from OpenCV and its dependencies at runtime.

### 1. Copy the Required DLLs

You must copy the necessary `.dll` files from the Conan cache into the same directory as your `main.exe`.

* **Your Executable's Location:** `build\Release\`
* **DLLs to Copy:**
    1.  **OpenCV DLLs:** Find them in a path like `C:\Users\YourUser\.conan2\p\openc...<hash>...\p\bin\`. Copy all the `.dll` files.
    2.  **LZMA DLL:** Find it in a path like `C:\Users\YourUser\.conan2\p\xz_ut...<hash>...\p\bin\`. Copy the `liblzma.dll` file.

Paste all these DLLs into the `build\Release\` folder alongside `main.exe`.

### 2. Run the Program

Now, you can run your program from the terminal:

```powershell
.\build\Release\main.exe
```

A window titled "OpenCV + Conan Demo" will appear, showing a green circle. Congratulations, you have successfully built and run an OpenCV application using a modern C++ workflow!
